---
title: "mbdmbd_viewer"
author: "Liam R Mitchell"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library("reticulate")
library("tidyverse")
library("lubridate")
library("fpc")
library("factoextra")
library("cluster")
```

# env setup
## associate all the packages with Renv
```{r renvInit, eval=FALSE}
renv::init()
```

```{r renvPyConnection}
# this PATH is the executable python from inside that
pyPath <- "/home/liam/miniconda3/envs/mbdmbd/bin/python"
renv::use_python(
    name = pyPath, 
    type = "conda")
```

```{python}
import imp
import mbdmbd
imp.reload(mbdmbd)
# args
#bamdir="/storage/liam/rebasecall/p48_anti-adar_guppy6.4"
#fdir="/data/nanopore/data/p48-51_20210210_Adar-Abeta-Aza_R1_SQK_RNA002_HT22/P48_Anti-adar/20210210_2130_1-A1-D1_PAE86248_66c1fc9e/"
bamdir="/storage/liam/rebasecall/p50_Scramble_Si_guppy6.4"
fdir="/data/nanopore/data/p48-51_20210210_Adar-Abeta-Aza_R1_SQK_RNA002_HT22/P50_Scramble-Si/20210210_2130_1-E9-H9_PAE86613_180257c4/"

arg = ['mbdmbd.py','--bamdir',bamdir,'--fdir',fdir]

kmer_table = mbdmbd.get_kmer_table(arg)
```

```{r pyRhandoff}
kmer_table <- reticulate::py$kmer_table
```

```{r plots}
plotdata <- kmer_table %>% 
  filter(kmer == "TGACG") %>% 
  mutate(sig_mean = lapply(signal, mean),
         sig_sd = lapply(signal, sd)) %>%
  mutate(sig_mean = unlist(sig_mean),
         sig_sd = unlist(sig_sd)) %>%
  mutate(start_time = ymd_hms(start_time)) %>% 
  mutate(hour = hour(start_time) + minute(start_time)/60)

p <- ggplot(plotdata, aes(x = sig_mean)) +
  geom_histogram() + 
  facet_grid(cols = vars(kmer))

plot(p)
```

```{r mixturemodel}
clusterdata <- kmer_table %>% 
  filter(kmer == "TGACG") 

signal_matrix <- as.data.frame(lapply(cbind(transpose(clusterdata$signal)), unlist), col.names = 1:50)

set.seed(220)
fviz_nbclust(signal_matrix, kmeans, method = "wss")

```

